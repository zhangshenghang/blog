(window.webpackJsonp=window.webpackJsonp||[]).push([[257],{735:function(s,n,a){"use strict";a.r(n);var t=a(20),e=Object(t.a)({},(function(){var s=this,n=s.$createElement,a=s._self._c||n;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"nginx-配置转发ftp"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#nginx-配置转发ftp"}},[s._v("#")]),s._v(" Nginx 配置转发FTP")]),s._v(" "),a("p",[a("strong",[s._v("nginx")]),s._v("从"),a("strong",[s._v("1.9.0")]),s._v("版本开始，新增了"),a("strong",[s._v("ngx_stream_core_module")]),s._v("模块，使"),a("strong",[s._v("nginx")]),s._v("⽀持四层负载均衡。默认编译的时候该模块并未编译进去，需要编译的时候添加**--with-stream**，使其⽀持"),a("strong",[s._v("stream")]),s._v("代理。")]),s._v(" "),a("h3",{attrs:{id:"安装stream模块"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装stream模块"}},[s._v("#")]),s._v(" 安装stream模块")]),s._v(" "),a("p",[s._v("（1）查看已安装Nginx编译参数")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@test11 local"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# nginx -V")]),s._v("\nnginx version: nginx/1.15.9\nbuilt by gcc "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4.8")]),s._v(".5 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20150623")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Red Hat "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4.8")]),s._v(".5-44"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("GCC"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" \nbuilt with OpenSSL "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.0")]),s._v(".2k-fips  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26")]),s._v(" Jan "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2017")]),s._v("\nTLS SNI support enabled\nconfigure arguments: --prefix"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/usr/local/nginx --with-http_ssl_module\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("（2）下载对应版本Nginx源码并重新编译")]),s._v(" "),a("p",[s._v("下载地址："),a("a",{attrs:{href:"http://nginx.org/en/download.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("http://nginx.org/en/download.html"),a("OutboundLink")],1)]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" http://nginx.org/download/nginx-1.15.9.tar.gz\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" -zxvf nginx-1.15.9.tar.gz \n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" nginx-1.15.9\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("编译")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("./configure --prefix"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/usr/local/nginx --with-http_ssl_module --with-stream  --with-stream_realip_module --without-http_rewrite_module\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("（3）执行make")]),s._v(" "),a("p",[s._v("注意：只执行make，不执行make install ，执行make install 会把原有nginx目录覆盖")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("make\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("（4）关闭Nginx服务")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("nginx -s stop\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("（5）替换原有的nginx启动文件")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 备份原有的启动文件")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" /usr/bin/nginx /usr/bin/nginx-no-stream\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将我们编译生成的nginx文件复制过去，并覆盖")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" /usr/local/src/nginx-1.15.9/objs/nginx /usr/bin/nginx\ncp：是否覆盖"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/usr/bin/nginx"')]),s._v("？ y\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 确认是否覆盖成功")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@test11 nginx-1.15.9"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# md5sum /usr/local/src/nginx-1.15.9/objs/nginx /usr/bin/nginx")]),s._v("\n90ac5d23625cfc5557084fe8d94d6a7f  /usr/local/src/nginx-1.15.9/objs/nginx\n90ac5d23625cfc5557084fe8d94d6a7f  /usr/bin/nginx\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("（6）配置成功")]),s._v(" "),a("h3",{attrs:{id:"配置转发ftp"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置转发ftp"}},[s._v("#")]),s._v(" 配置转发FTP")]),s._v(" "),a("p",[s._v("参考:"),a("a",{attrs:{href:"https://blog.51cto.com/u_15127630/2738588",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://blog.51cto.com/u_15127630/2738588"),a("OutboundLink")],1)]),s._v(" "),a("p",[a("strong",[s._v("（0）配置思路")])]),s._v(" "),a("p",[s._v("先了解下FTP的连接方式")]),s._v(" "),a("p",[s._v("FTP连接模式具有两种，分别为主动模式（PORT）以及被动模式（PASV）。")]),s._v(" "),a("p",[a("strong",[s._v("主动模式:")])]),s._v(" "),a("ul",[a("li",[a("p",[s._v("当FTP客户端以主动模式连接服务端时，客户端以动态选择的端口号向服务器的命令端口发起连接；")])]),s._v(" "),a("li",[a("p",[s._v("连接建立后，用户在发出列目录或传输文件的命令后，会要求建立数据连接；")])]),s._v(" "),a("li",[a("p",[s._v("FTP客户端在控制连接上发出主动模式指令，告知服务器客户端的数据连接端口号；")])]),s._v(" "),a("li",[a("p",[s._v("服务端收到指令后，会使用20号端口连接客户端指定的数据连接端口号，从而建立数据连接。")])])]),s._v(" "),a("p",[a("strong",[s._v("被动模式：")])]),s._v(" "),a("ul",[a("li",[a("p",[s._v("被动模式的连接过程与主动模式类似，区别点在于客户端发出列目录或传输文件的命令后，客户端会发送PASV指令至服务端；")])]),s._v(" "),a("li",[a("p",[s._v("服务端收到PASV指令后，告知客户端服务端的数据连接IP地址和端口号；")])]),s._v(" "),a("li",[a("p",[s._v("客户端根据返回的服务端数据连接IP和端口号，发起数据连接。")])])]),s._v(" "),a("p",[a("strong",[s._v("存在问题 & 解决思路：")])]),s._v(" "),a("p",[s._v("当前，客户端需要通过Nginx代理方能访问FTP服务端。通过Nginx stream可以实现控制命令的转发，但是对于客户端和服务端协商的数据连接，较难实现代理。")]),s._v(" "),a("p",[s._v("不过查阅相关文档，vsftpd支持设置数据连接的端口范围，亦支持设置数据连接的IP。")]),s._v(" "),a("p",[s._v("因此，"),a("strong",[s._v("我们可以指定vsftpd模式为被动模式（默认即为被动模式），设置数据连接IP地址为Nginx代理地址，合理设置数据连接端口范围（Nginx监听本地此端口范围内数据）")]),s._v("。当ftp客户端与vsftpd服务端协商数据连接后，ftp客户端根据数据连接IP（已设置为Nginx代理地址）以及端口号发起连接（实际连接至Nginx服务器），Nginx将此端口上监听的数据转发至vsftpd对应的数据端口。")]),s._v(" "),a("p",[a("strong",[s._v("（1）FTP配置")])]),s._v(" "),a("div",{staticClass:"language-properties line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-properties"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 开启pasv模式")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token attr-name"}},[s._v("pasv_enable")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[s._v("YES")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# pasv模式下，数据连接最小端口号")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token attr-name"}},[s._v("pasv_min_port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[s._v("50000")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# pasv模式下，数据连接最大端口号")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token attr-name"}},[s._v("pasv_max_port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[s._v("50002   ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 关闭pasv模式下，关闭对IP地址的检查，此检查确保控制连接和数据连接来自同一IP")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token attr-name"}},[s._v("pasv_promiscuous")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[s._v("YES")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("blockquote",[a("p",[s._v("pasv_promiscuous关闭存在安全隐患；\n在实际组网情况下，Nginx转发时可设置保留源IP信息，但是客户端与服务端无法直接访问，因此只能放弃保留源IP信息。")])]),s._v(" "),a("p",[a("strong",[s._v("（2）重启"),a("code",[s._v("vsftpd")])])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("systemctl restart vsftpd \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("strong",[s._v("（3）Nginx配置")])]),s._v(" "),a("p",[s._v("这里需要将ftp配置的数据连接端口号范围内的端口都配置转发，即"),a("code",[s._v("pasv_max_port")]),s._v("与"),a("code",[s._v("pasv_max_port")]),s._v("之间的端口")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("stream{\n\t\t# FTP端口转发\n    upstream ftp{\n        hash $remote_addr consistent;\n        server 10.8.10.16:21;\n    }\n    server {\n        listen 18989;\n        proxy_connect_timeout 300s;\n        proxy_timeout 300s;\n        proxy_pass ftp;\n    }\n\n    \n    # 转发客户端发送到Nginx代理机的数据连接\n    server {\n       listen 50000;\n       proxy_pass ftp_pasv1;\n    }\n    upstream ftp_pasv1 {\n        server 10.8.10.16:50000;\n    }\n    # 转发客户端发送到Nginx代理机的数据连接\n    server {\n       listen 50002;\n       proxy_pass ftp_pasv3;\n    }\n    upstream ftp_pasv3 {\n        server 10.8.10.16:50002;\n    }\n    # 转发客户端发送到Nginx代理机的数据连接\n    server {\n       listen 50001;\n       proxy_pass ftp_pasv2;\n    }\n    upstream ftp_pasv2 {\n        server 10.8.10.16:50001;\n    }\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br")])]),a("p",[a("strong",[s._v("（3）重启Nginx")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("nginx -s reload\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("strong",[s._v("（4）配置完成")])]),s._v(" "),a("p",[s._v("访问Nginx配置的地址可以成功获取FTP信息")])])}),[],!1,null,null,null);n.default=e.exports}}]);